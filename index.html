<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>進制轉換器｜Base Converter (2–62，含小數)</title>
  <style>
    :root { --bg:#0b1020; --panel:#111726; --muted:#9fb4d7; --text:#eef3fb; --error:#ff6b6b; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Noto Sans, Arial; background: var(--bg); color: var(--text); }
    .wrap { max-width: 760px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 26px; margin: 0 0 14px; }
    .card { background: var(--panel); border:1px solid rgba(124,193,255,.25); border-radius: 14px; padding: 16px; }
    label { display:block; font-weight:600; margin-bottom:8px; }
    input[type="text"], input[type="number"] {
      width: 100%; padding: 11px 12px; border-radius: 10px;
      background:#0e1526; border:1px solid rgba(124,193,255,.35); color: var(--text); font-size: 15px;
    }
    input::placeholder { color:#a9bddf; }
    .row {
      display:grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: end; margin-top:10px;
    }
    @media (max-width: 540px){
      .row { grid-template-columns: 1fr 1fr; }
      .row .swapcell { grid-column: 1 / -1; }
    }
    .muted { color: var(--muted); font-size: 13px; margin-top:6px; }
    .alert { color: var(--error); min-height: 1.2em; margin-top: 8px; }
    .result { margin-top: 14px; }
    .caption { font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    .out { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0e1526; border:1px solid rgba(124,193,255,.35); border-radius: 10px; padding: 11px 12px; word-break: break-all; }
    .swapbtn {
      height: 38px; padding: 0 12px; border-radius: 10px; cursor: pointer;
      background: transparent; color: var(--text);
      border: 1px dashed rgba(124,193,255,.6);
    }
    .swapbtn:hover { border-style: solid; }
    /* 快速基底按鈕 */
    .quick { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
    .chip {
      display:inline-flex; align-items:center; justify-content:center;
      padding: 6px 10px; border-radius: 999px; cursor: pointer;
      background: #0e1526; color: var(--text); border:1px solid rgba(124,193,255,.35);
      font-size: 13px; line-height: 1;
    }
    .chip:hover { border-color: rgba(124,193,255,.7); }
    .chip.active { outline: 2px solid rgba(124,193,255,.8); }
    details { margin-top: 10px; }
    details > summary { cursor: pointer; font-weight: 600; }
    ul { margin: 8px 0 0 18px; }
    code { background:#0e1526; border:1px solid rgba(124,193,255,.25); border-radius:6px; padding:0 4px; }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>進制轉換器（2–62，含小數）</h1>

    <!-- 工具區 -->
    <section class="card" aria-labelledby="tool-title">
      <label for="val" id="tool-title">數值（x 進位）</label>
      <input id="val" type="text" placeholder="例：-1a7.f0 或 1011.01" autocomplete="off" spellcheck="false">
      <div class="muted">允許字元：0–9 a–z A–Z（<strong>大小寫有別</strong>），小數點用 <code>.</code>；可使用 <code>+</code>/<code>-</code> 與底線 <code>_</code>。</div>

      <div class="row">
        <div>
          <label for="from">x（來源進位）</label>
          <input id="from" type="number" min="2" max="62" value="16" inputmode="numeric">
          <!-- 常用基底快速鍵：x -->
          <div class="quick" data-target="from">
            <button class="chip" type="button" data-base="2">2</button>
            <button class="chip" type="button" data-base="8">8</button>
            <button class="chip" type="button" data-base="10">10</button>
            <button class="chip" type="button" data-base="16">16</button>
            <button class="chip" type="button" data-base="36">36</button>
            <button class="chip" type="button" data-base="62">62</button>
          </div>
        </div>

        <div class="swapcell" style="display:flex; align-items:flex-end; justify-content:center;">
          <button id="swap" class="swapbtn" type="button" title="交換 x 與 y（Alt+S）">↔ 交換 x / y</button>
        </div>

        <div>
          <label for="to">y（目標進位）</label>
          <input id="to" type="number" min="2" max="62" value="10" inputmode="numeric">
          <!-- 常用基底快速鍵：y -->
          <div class="quick" data-target="to">
            <button class="chip" type="button" data-base="2">2</button>
            <button class="chip" type="button" data-base="8">8</button>
            <button class="chip" type="button" data-base="10">10</button>
            <button class="chip" type="button" data-base="16">16</button>
            <button class="chip" type="button" data-base="36">36</button>
            <button class="chip" type="button" data-base="62">62</button>
          </div>
        </div>
      </div>

      <div id="alert" class="alert" aria-live="polite"></div>

      <div class="result">
        <div class="caption">轉換結果</div>
        <div id="out" class="out">（輸入後即時顯示）</div>
      </div>
    </section>

    <!-- 使用說明區 -->
    <section class="card" style="margin-top:14px;">
      <details open>
        <summary>使用說明</summary>
        <ul>
          <li>輸入 x 進位數（可含小數點 <code>.</code>、<code>+</code>/<code>-</code>、底線 <code>_</code>）。</li>
          <li>選擇 x、y 進位：可直接輸入數字、點下方「常用基底」、或用鍵盤：↑/↓±1、Shift+↑/↓±5、Ctrl/⌘+↑/↓跳到下一個常用基底。</li>
          <li>按 <em>↔ 交換 x / y</em> 或快捷鍵 <code>Alt+S</code> 可快速交換。</li>
          <li>字元集 <code>0-9 a-z A-Z</code>；小數以分數精準計算、循環小數自動偵測（超過長度會以 <code>…</code> 截斷）。</li>
        </ul>
      </details>
    </section>
  </main>

  <script>
    (function(){
      "use strict";
      // ===== 可調參數 =====
      const MAX_FRAC = 32;        // 最大小數位數
      const SHOW_REPEAT = true;   // 顯示循環括號
      const QUICK = [2,8,10,16,36,62];

      // 字元集與映射
      const DIGITS = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const charToVal = new Map([...DIGITS].map((c,i)=>[c,i]));

      // 小工具
      const $ = id => document.getElementById(id);
      const $val = $("val"), $from = $("from"), $to = $("to"),
            $out = $("out"), $alert = $("alert"), $swap = $("swap");

      const abs = x => (x < 0n ? -x : x);
      const clamp = (n, lo, hi) => Math.min(Math.max(n, lo), hi);
      function gcd(a,b){ a=abs(a); b=abs(b); while(b){ const t=a%b; a=b; b=t; } return a||1n; }
      function sanitize(s){ return s.trim().replace(/\s+/g,"").replace(/_/g,""); }

      function splitNumber(raw){
        if(!raw) throw new Error("請輸入數值");
        let s = sanitize(raw);
        let sign = 1n;
        if(s[0]==="+") s = s.slice(1);
        else if(s[0]==="-"){ sign = -1n; s = s.slice(1); }
        if(s.split(".").length > 2) throw new Error("格式錯誤：小數點只能有一個");
        let [intStr="", fracStr=""] = s.split(".");
        if(intStr === "" && fracStr === "") throw new Error("請輸入有效的數字");
        return { sign, intStr, fracStr };
      }

      function validatePart(part, base){
        for(let i=0;i<part.length;i++){
          const ch = part[i];
          if(!charToVal.has(ch)) return `不支援的字元「${ch}」`;
          const v = charToVal.get(ch);
          if(v >= base) return `字元「${ch}」超過基數 ${base} 的範圍`;
        }
        return null;
      }

      // 解析為 num/den（BigInt）
      function parseRational(raw, base){
        if(!(base>=2 && base<=62)) throw new Error("基數必須介於 2 到 62");
        const { sign, intStr, fracStr } = splitNumber(raw);
        const v1 = validatePart(intStr, base); if(v1) throw new Error(v1);
        const v2 = validatePart(fracStr, base); if(v2) throw new Error(v2);

        const b = BigInt(base);
        // 整數部
        let intVal = 0n;
        for(let i=0;i<intStr.length;i++){
          intVal = intVal * b + BigInt(charToVal.get(intStr[i]));
        }
        // 小數部 → 分數
        let fracNum = 0n, fracDen = 1n;
        for(let i=0;i<fracStr.length;i++){
          fracNum = fracNum * b + BigInt(charToVal.get(fracStr[i]));
          fracDen = fracDen * b;
        }
        let num = sign * (intVal * fracDen + fracNum);
        let den = fracDen || 1n;

        const g = gcd(num, den);
        return { num: num / g, den: den / g };
      }

      // num/den 轉為 base 表示字串（含循環偵測與截斷）
      function toBaseString(num, den, base){
        if(!(base>=2 && base<=62)) throw new Error("基數必須介於 2 到 62");
        const signStr = (num < 0n) ? "-" : "";
        let n = abs(num), d = den, r = n % d;
        const b = BigInt(base);

        // 整數部
        let intQ = n / d;
        const intDigits = [];
        if(intQ === 0n) intDigits.push("0");
        else {
          while(intQ > 0n){
            intDigits.push(DIGITS[Number(intQ % b)]);
            intQ = intQ / b;
          }
          intDigits.reverse();
        }

        // 小數部
        if(r === 0n) return signStr + intDigits.join("");

        let frac = "";
        const seen = new Map(); // remainder(str) -> index
        let idx = 0, repeatStart = -1;

        while(r !== 0n && frac.length < MAX_FRAC){
          if(SHOW_REPEAT){
            const key = r.toString();
            if(seen.has(key)){ repeatStart = seen.get(key); break; }
            seen.set(key, idx);
          }
          r = r * b;
          const digit = Number(r / d);
          r = r % d;
          frac += DIGITS[digit];
          idx++;
        }

        if(SHOW_REPEAT && r !== 0n && repeatStart >= 0){
          const a = frac.slice(0, repeatStart);
          const cyc = frac.slice(repeatStart);
          return signStr + intDigits.join("") + "." + a + "(" + cyc + ")";
        }
        if(r !== 0n && frac.length >= MAX_FRAC){
          frac += "…"; // 截斷顯示
        }
        return signStr + intDigits.join("") + "." + frac;
      }

      function render(){
        $alert.textContent = "";
        try{
          const fromBase = Number($from.value);
          const toBase = Number($to.value);
          const { num, den } = parseRational($val.value, fromBase);
          const out = toBaseString(num, den, toBase);
          $out.textContent = out;
        }catch(e){
          $out.textContent = "—";
          $alert.textContent = e.message || String(e);
        }
        syncQuickActive();
      }

      // ===== 快速基底按鈕 =====
      function syncQuickActive(){
        document.querySelectorAll('.quick').forEach(box=>{
          const target = box.getAttribute('data-target');
          const val = Number((target === 'from' ? $from.value : $to.value) || 10);
          box.querySelectorAll('.chip').forEach(ch=>{
            const b = Number(ch.getAttribute('data-base'));
            ch.classList.toggle('active', b === val);
          });
        });
      }
      function bindQuick(box){
        box.addEventListener('click', (e)=>{
          const btn = e.target.closest('.chip');
          if(!btn) return;
          const base = Number(btn.getAttribute('data-base'));
          const target = box.getAttribute('data-target');
          if(target === 'from') $from.value = base; else $to.value = base;
          render();
        });
      }
      document.querySelectorAll('.quick').forEach(bindQuick);

      // ===== 鍵盤強化：↑/↓、Shift、Ctrl/⌘ 跳常用基底 =====
      function nextQuick(curr, dir){
        if(dir > 0){ for(const b of QUICK){ if(b > curr) return b; } return QUICK[QUICK.length-1]; }
        for(let i=QUICK.length-1;i>=0;i--){ if(QUICK[i] < curr) return QUICK[i]; }
        return QUICK[0];
      }
      function handleBaseKey(ev, el){
        const v0 = Number(el.value || 10);
        if(ev.key === 'ArrowUp' || ev.key === 'ArrowDown'){
          ev.preventDefault();
          const dir = ev.key === 'ArrowUp' ? 1 : -1;
          let v = v0;
          if(ev.ctrlKey || ev.metaKey){
            v = nextQuick(v0, dir);
          } else if(ev.shiftKey){
            v = v0 + dir * 5;
          } else {
            v = v0 + dir;
          }
          el.value = clamp(v, 2, 62);
          render();
        }
      }
      $from.addEventListener('keydown', e=>handleBaseKey(e, $from));
      $to.addEventListener('keydown', e=>handleBaseKey(e, $to));

      // 交換 x / y（按鈕 + Alt+S）
      $swap.addEventListener("click", ()=>{
        const a = $from.value;
        $from.value = $to.value;
        $to.value = a;
        render();
      });
      document.addEventListener('keydown', (e)=>{
        if(e.altKey && (e.key.toLowerCase() === 's')){
          e.preventDefault();
          $swap.click();
        }
      });

      // 變更即時轉換
      ["input","change","keyup"].forEach(ev=>{
        $val.addEventListener(ev, render);
        $from.addEventListener(ev, render);
        $to.addEventListener(ev, render);
      });

      render(); // 初始
    })();
  </script>
</body>
</html>
