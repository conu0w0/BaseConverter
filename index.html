<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>進制轉換器｜Base Converter (2–62, 含小數)</title>
  <style>
    :root { --bg:#0b1020; --panel:#111726; --muted:#9fb4d7; --text:#eef3fb; --error:#ff6b6b; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Noto Sans, Arial; background: var(--bg); color: var(--text); }
    .wrap { max-width: 760px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 26px; margin: 0 0 14px; }
    .card { background: var(--panel); border:1px solid rgba(124,193,255,.25); border-radius: 14px; padding: 16px; }
    label { display:block; font-weight:600; margin-bottom:8px; }
    input[type="text"], input[type="number"] {
      width: 100%; padding: 11px 12px; border-radius: 10px;
      background:#0e1526; border:1px solid rgba(124,193,255,.35); color: var(--text); font-size: 15px;
    }
    input::placeholder { color:#a9bddf; }
    .row { display:grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: end; margin-top:10px; }
    @media (max-width: 540px){
      .row { grid-template-columns: 1fr 1fr; }
      .swapcell { grid-column: 1 / -1; }
    }
    .muted { color: var(--muted); font-size: 13px; margin-top:6px; }
    .alert { color: var(--error); min-height: 1.2em; margin-top: 8px; }
    .result { margin-top: 14px; }
    .caption { font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    .out { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0e1526; border:1px solid rgba(124,193,255,.35); border-radius: 10px; padding: 11px 12px; word-break: break-all; }
    .swapbtn {
      height: 38px; padding: 0 12px; border-radius: 10px; cursor: pointer;
      background: transparent; color: var(--text);
      border: 1px dashed rgba(124,193,255,.6);
    }
    .swapbtn:hover { border-style: solid; }
    details { margin-top: 10px; }
    details > summary { cursor: pointer; font-weight: 600; }
    ul { margin: 8px 0 0 18px; }
    code { background:#0e1526; border:1px solid rgba(124,193,255,.25); border-radius:6px; padding:0 4px; }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>進制轉換器（2–62，支援小數）</h1>

    <!-- 工具區 -->
    <section class="card" aria-labelledby="tool-title">
      <label for="val" id="tool-title">數值（x 進位，支援小數點 .）</label>
      <input id="val" type="text" placeholder="例：-1a7_f0.3B 或 1011.011" autocomplete="off" spellcheck="false">
      <div class="muted">允許字元：0–9 a–z A–Z（<strong>大小寫有別</strong>）；可用 <code>+</code>/<code>-</code> 與底線 <code>_</code> 分隔；小數點使用 <code>.</code>。</div>

      <div class="row">
        <div>
          <label for="from">x（來源進位）</label>
          <input id="from" type="number" min="2" max="62" value="16" inputmode="numeric">
        </div>

        <div class="swapcell" style="display:flex; align-items:flex-end; justify-content:center;">
          <button id="swap" class="swapbtn" type="button" title="交換 x 與 y（Swap x and y）">↔ 交換 x / y</button>
        </div>

        <div>
          <label for="to">y（目標進位）</label>
          <input id="to" type="number" min="2" max="62" value="10" inputmode="numeric">
        </div>
      </div>

      <div style="margin-top:10px;">
        <label for="prec">輸出小數位數（0–64）</label>
        <input id="prec" type="number" min="0" max="64" value="32" inputmode="numeric">
        <div class="muted">若為循環小數，將以括號標示循環段（例如 <code>0.(3)</code>）。若在精度內尚未遇到循環，將以截斷方式顯示。</div>
      </div>

      <div id="alert" class="alert" aria-live="polite"></div>

      <div class="result">
        <div class="caption">轉換結果</div>
        <div id="out" class="out">（輸入後即時顯示）</div>
      </div>
    </section>

    <!-- 使用說明區 -->
    <section class="card" style="margin-top:14px;">
      <details open>
        <summary>使用說明</summary>
        <ul>
          <li>在「數值」輸入 <strong>x 進位數</strong>，可包含小數點 <code>.</code> 與 <code>+</code>/<code>-</code>、底線 <code>_</code>（底線只做分隔）。</li>
          <li>設定「x」與「y」為 2–62 的整數。字元集：<code>0-9 a-z A-Z</code>（<code>a</code>=10 … <code>z</code>=35，<code>A</code>=36 … <code>Z</code>=61）。</li>
          <li>小數轉換：以分數 <code>p/q</code>（<code>q = x^k</code>）計算；輸出時以「乘基取整」產生 y 進位小數，遇到重複餘數則以括號標出循環段。</li>
          <li>「輸出小數位數」限制最長輸出長度；若你想完整看到循環，建議設稍大（例如 32）。</li>
        </ul>
      </details>
    </section>
  </main>

  <script>
    (function(){
      "use strict";
      // 字元表：0-9 a-z A-Z
      const DIGITS = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const charToVal = new Map([...DIGITS].map((c,i)=>[c,i]));

      const $ = (id)=>document.getElementById(id);
      const $val = $("val"), $from = $("from"), $to = $("to"), $prec = $("prec"),
            $out = $("out"), $alert = $("alert"), $swap = $("swap");

      function sanitize(s){ return s.trim().replace(/\s+/g,"").replace(/_/g,""); }

      function validateDigits(s, base){
        for(let i=0;i<s.length;i++){
          const ch = s[i];
          if(!charToVal.has(ch)) return {ok:false, msg:`不支援的字元「${ch}」`};
          const v = charToVal.get(ch);
          if(v >= base) return {ok:false, msg:`字元「${ch}」超過基數 ${base} 的範圍`};
        }
        return {ok:true};
      }

      // 將字串（不含符號與小數點）轉為 BigInt（以 base 解析）
      function parseIntPart(str, base){
        if(str.length === 0) return 0n;
        const b = BigInt(base);
        let acc = 0n;
        for(let i=0;i<str.length;i++){
          const d = BigInt(charToVal.get(str[i]));
          acc = acc * b + d;
        }
        return acc;
      }

      // 解析含小數：回傳分數 num/den（BigInt）
      function parseToFraction(raw, base){
        if(!(base>=2 && base<=62)) throw new Error("基數必須介於 2 到 62");
        if(!raw) throw new Error("請輸入數值");

        // 處理符號
        let sign = 1n;
        let s = raw;
        if(s[0]==="+") s = s.slice(1);
        else if(s[0]==="-"){ sign = -1n; s = s.slice(1); }
        s = sanitize(s);

        // 只能有一個小數點
        const parts = s.split(".");
        if(parts.length > 2) throw new Error("發現多個小數點 .");

        const intStr = parts[0] || "";
        const fracStr = parts[1] || "";

        // 檢查字元
        const v1 = validateDigits(intStr, base);
        if(!v1.ok) throw new Error(v1.msg);
        const v2 = validateDigits(fracStr, base);
        if(!v2.ok) throw new Error(v2.msg);

        // 整數部分
        const Nint = parseIntPart(intStr, base);

        // 小數部分，長度 k，分母 base^k，分子為以 base 解析的整數
        let Nfrac = 0n, Q = 1n;
        const b = BigInt(base);
        if(fracStr.length > 0){
          // 分子：當作整數解析
          Nfrac = parseIntPart(fracStr, base);
          // 分母：b^k
          Q = b ** BigInt(fracStr.length);
        }
        // 合併： (Nint * Q + Nfrac) / Q
        let num = Nint * Q + Nfrac;
        let den = Q;
        if(sign < 0n) num = -num;
        return { num, den };
      }

      // 將分數 num/den 轉成 y 進位字串，帶小數（循環用括號），precision 為最大小數位
      function fractionToBase(num, den, base, precision){
        if(!(base>=2 && base<=62)) throw new Error("基數必須介於 2 到 62");
        if(den === 0n) throw new Error("分母不可為 0");
        const b = BigInt(base);

        let sign = "";
        if(num < 0n){ sign = "-"; num = -num; }

        // 整數部分
        const intPart = num / den;
        let rem = num % den;
        const intStr = bigIntToBase(intPart, base);

        if(rem === 0n || precision === 0) return sign + intStr;

        // 小數部分：乘基取整 + 餘數循環偵測
        const seen = new Map(); // remainder -> index
        let digits = [];
        let idx = 0;
        while(rem !== 0n && idx < precision){
          if(seen.has(rem)){
            const pos = seen.get(rem);
            const head = digits.slice(0, pos).join("");
            const cycle = digits.slice(pos).join("");
            return sign + intStr + "." + head + "(" + cycle + ")";
          }
          seen.set(rem, idx);
          rem = rem * b;
          const d = Number(rem / den);     // 0..base-1
          rem = rem % den;
          digits.push(DIGITS[d]);
          idx++;
        }
        // 若在精度內未歸零，採截斷表示
        return sign + intStr + "." + digits.join("");
      }

      // BigInt → 指定進位（整數）
